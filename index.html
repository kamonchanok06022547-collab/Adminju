// 1. ฟังก์ชันส่งสถานะไปที่ Firebase
function setOnlineStatus(status) {
    const myPass = sessionStorage.getItem("myPass");
    if (myPass) {
        firebase.database().ref('online_users/' + myPass).update({
            status: status
        });
    }
}

// 2. ตั้งค่าให้ออฟไลน์ทันทีเมื่อ "ปิดแท็บ" หรือ "เน็ตหลุด" (สำคัญมาก)
function setupPresence() {
    const myPass = sessionStorage.getItem("myPass");
    if (myPass) {
        const myRef = firebase.database().ref('online_users/' + myPass);
        // เมื่อหลุดปุ๊บ ให้ Firebase แก้เป็น offline ทันที
        myRef.onDisconnect().update({ status: "offline" });
    }
}

// 3. ตรวจจับการเปิดหน้าเว็บค้างไว้
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === 'visible') {
        setOnlineStatus("online"); // กลับมาดูหน้าเว็บ = เขียว
    } else {
        setOnlineStatus("offline"); // สลับแอปไปที่อื่น = เทา
    }
});

// 4. เรียกใช้ฟังก์ชันตอนโหลดหน้าเว็บเสร็จ
window.addEventListener('load', () => {
    if (sessionStorage.getItem("sessionId")) {
        setOnlineStatus("online");
        setupPresence();
    }
});
