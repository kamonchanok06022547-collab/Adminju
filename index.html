<div class="card">
    <h3 style="color:#6a1b9a;">üîë ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™ & ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</h3>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>‡∏£‡∏´‡∏±‡∏™ (Key)</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                    <th>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="keyListTableBody"></tbody>
        </table>
    </div>
</div>

<script>
function loadKeys() {
    db.ref('license_keys').on('value', (snapshot) => {
        const tbody = document.getElementById("keyListTableBody");
        tbody.innerHTML = "";
        const data = snapshot.val();
        if(data) {
            Object.keys(data).forEach(id => {
                const k = data[id];
                const now = new Date().getTime();
                let remainingText = "-";
                let statusColor = "green";

                if (k.expireDate) {
                    const diff = k.expireDate - now;
                    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    if (days > 0) {
                        remainingText = days + " ‡∏ß‡∏±‡∏ô";
                    } else {
                        remainingText = "‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏";
                        statusColor = "red";
                    }
                }

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><strong>${k.key}</strong></td>
                    <td>${k.status === 'unused' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ' : 'ID: '+k.usedBy}</td>
                    <td style="font-weight:bold; color:${statusColor}">${remainingText}</td>
                    <td>${k.expireDate ? new Date(k.expireDate).toLocaleDateString('th-TH') : "-"}</td>
                    <td>
                        <button onclick="renewKey('${id}')" style="background:#4caf50; color:white;">+30 ‡∏ß‡∏±‡∏ô</button>
                        <button onclick="deleteKey('${id}')" style="background:#ff5252; color:white;">‡∏•‡∏ö</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
window.renewKey = (id) => {
    const keyRef = db.ref('license_keys/' + id);
    keyRef.once('value').then((snap) => {
        const data = snap.val();
        if (!data.expireDate) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)");
        
        const newExpire = data.expireDate + (30 * 24 * 60 * 60 * 1000); // ‡πÄ‡∏û‡∏¥‡πà‡∏° 30 ‡∏ß‡∏±‡∏ô
        keyRef.update({ expireDate: newExpire });
        alert("‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡πâ‡∏£‡∏´‡∏±‡∏™ " + id + " ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
    });
}
</script>
